<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2015 The Project Buendia Authors
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License"); you may not
  ~ use this file except in compliance with the License.  You may obtain a copy
  ~ of the License at: http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software distrib-
  ~ uted under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES
  ~ OR CONDITIONS OF ANY KIND, either express or implied.  See the License for
  ~ specific language governing permissions and limitations under the License.
  -->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">
    <changeSet id="add-person-date-updated-index" author="@capnfabs">
        <addColumn tableName="person">
            <column name="buendia_date_updated"
                    type="TIMESTAMP"
                    defaultValueComputed="CURRENT_TIMESTAMP"
                    remarks="Automatically updated by the `buendia_person_update_date_updated` and `buendia_person_insert_date_updated` triggers."/>
        </addColumn>
        <createIndex tableName="person" indexName="buendia_pagination_index">
            <column name="buendia_date_updated" />
            <column name="uuid" />
        </createIndex>
        <sql>
            DROP TRIGGER IF EXISTS `buendia_person_update_date_updated`;
            CREATE TRIGGER `buendia_person_update_date_updated` BEFORE UPDATE
            ON `person` FOR EACH ROW SET
            NEW.buendia_date_updated = NOW();

            DROP TRIGGER IF EXISTS `buendia_person_insert_date_updated`;
            CREATE TRIGGER `buendia_person_insert_date_updated` BEFORE INSERT
            ON `person` FOR EACH ROW SET
            NEW.buendia_date_updated = NOW();
        </sql>
        <rollback>
            <dropColumn tableName="person" columnName="buendia_date_updated" />
            <dropIndex tableName="person" indexName="buendia_pagination_index" />
            <sql>
                DROP TRIGGER IF EXISTS `buendia_person_update_date_updated`;
                DROP TRIGGER IF EXISTS `buendia_person_insert_date_updated`;
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>
