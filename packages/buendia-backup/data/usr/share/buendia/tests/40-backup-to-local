BUENDIA_TEST_BACKUP_TARGET=/var/backups/buendia/backup.$(date +%Y-%m-%d)

# When the backup cron job runs
test_10_run_backup_cron () {
    rm -rf $BUENDIA_TEST_BACKUP_TARGET
    execute_cron_right_now backup
}

# Then it encrypts the backup
test_20_no_unencrypted_backup_files () {
    ! [ -f $BUENDIA_TEST_BACKUP_TARGET/buendia.tar.gz \
     -o -f $BUENDIA_TEST_BACKUP_TARGET/openmrs.zip ]
}

# And it stores a tarball of site configs locally
test_30_cron_saved_site_config () {
    cp $BUENDIA_TEST_BACKUP_TARGET/buendia.tar.gz.enc .
    decrypt_file buendia.tar.gz
    tar tfz buendia.tar.gz
}

# And it stores a database dump locally
test_30_cron_saved_database_dump () {
    cp $BUENDIA_TEST_BACKUP_TARGET/openmrs.zip.enc .
    decrypt_file openmrs.zip
    unzip -t openmrs.zip
}

# And it stores a list of installed Buendia packages
test_40_cron_saved_package_list () {
    [ -s $BUENDIA_TEST_BACKUP_TARGET/buendia.list ]
}

# But it doesn't back up the system key locally
test_50_no_local_system_key_backup () {
    [ ! -f $BUENDIA_TEST_BACKUP_TARGET/system.key ]
}
